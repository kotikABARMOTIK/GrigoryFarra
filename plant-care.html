<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Уход за растениями - Garden Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="js/settings-manager.js"></script>
    <script src="theme-manager.js"></script>
    <script src="lang.js"></script>
    <style>
:root {
            --primary: #4CAF50;
            --primary-dark: #2E7D32;
            --primary-light: #E8F5E9;
            --accent: #FF4081;
            --text: #333333;
            --text-light: #666666;
            --background: #F9F9F9;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --primary: #66bb6a;
            --primary-dark: #388e3c;
            --primary-light: #1b5e20;
            --text: #ffffff;
            --text-light: #b0b0b0;
            --background: #121212;
            --card-bg: #1e1e1e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #333333;
        }

        [data-theme="green"] {
            --primary: #4CAF50;
            --primary-dark: #2E7D32;
            --primary-light: #E8F5E9;
            --text: #1B5E20;
            --text-light: #4CAF50;
            --background: #F1F8E9;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(76, 175, 80, 0.15);
            --border: #C8E6C9;
        }

        [data-theme="blue"] {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --text: #0D47A1;
            --text-light: #2196F3;
            --background: #E3F2FD;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
            --border: #BBDEFB;
        }

        [data-theme="green"].dark-mode {
            --primary: #66bb6a;
            --primary-dark: #388e3c;
            --primary-light: #1b5e20;
            --text: #e8f5e9;
            --text-light: #a5d6a7;
            --background: #1b311c;
            --card-bg: #2e4630;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #1b5e20;
        }

        [data-theme="blue"].dark-mode {
            --primary: #64b5f6;
            --primary-dark: #1976d2;
            --primary-light: #0d47a1;
            --text: #e3f2fd;
            --text-light: #90caf9;
            --background: #0d1b33;
            --card-bg: #1e2b47;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #1565c0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        .flower {
            position: fixed;
            z-index: 0;
            opacity: 0.7;
            pointer-events: none;
        }

        .flower-1 {
            top: 10%;
            left: 10%;
            font-size: 40px;
            color: var(--primary);
            transform: rotate(-15deg);
        }

        .flower-2 {
            bottom: 15%;
            right: 10%;
            font-size: 35px;
            color: var(--primary-dark);
            transform: rotate(25deg);
        }

        .flower-3 {
            top: 20%;
            right: 15%;
            font-size: 30px;
            color: var(--accent);
            transform: rotate(10deg);
        }

        .flower-4 {
            bottom: 20%;
            left: 15%;
            font-size: 45px;
            color: var(--primary-light);
            transform: rotate(-20deg);
        }

        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            border-radius: 50% 50% 50% 0;
            opacity: 0.6;
            animation: fall 15s linear infinite;
            pointer-events: none;
        }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0.7; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-dark);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-icon {
            font-size: 2em;
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1.1em;
            cursor: pointer;
        }

        .user-level {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 2px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            margin-left: 30px;
        }

        .nav-item {
            padding: 8px 16px;
            border-radius: 8px;
            color: var(--primary-dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .game-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 30px;
            min-height: 70vh;
        }

        .plant-info {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .care-area {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .plant-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--primary-light);
            border-radius: var(--radius);
            margin-bottom: 25px;
            position: relative;
            min-height: 350px;
            border: 1px solid var(--border);
            padding: 20px;
        }

        .plant-image {
            font-size: 8em;
            transition: all 0.5s ease;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .plant-mood {
            font-size: 1.3em;
            font-weight: 600;
            text-align: center;
            padding: 12px 20px;
            border-radius: 25px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .plant-needs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .need-item {
            background: var(--primary-light);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            position: relative;
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .need-item:hover {
            transform: translateY(-2px);
        }

        .need-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .need-bar {
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .need-progress {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .water-progress { background: #2196f3; }
        .light-progress { background: #ffeb3b; }
        .food-progress { background: #8bc34a; }
        .love-progress { background: #e91e63; }

        .care-tools {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: auto;
        }

        .tool {
            background: var(--primary-light);
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .tool:hover {
            transform: translateY(-3px);
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .tool:disabled {
            background: var(--border);
            border-color: var(--text-light);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
            color: var(--text-light);
        }

        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: var(--radius);
            font-size: 1.5em;
        }

        .plant-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat {
            background: var(--primary-light);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .stat:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .progress-container {
            margin: 25px 0;
            padding: 20px;
            background: var(--primary-light);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .level-bar {
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-top: 10px;
        }

        .level-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            color: var(--text);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 0px;
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        .achievement-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
            display: inline-block;
            box-shadow: var(--shadow);
        }

        .plant-evolution {
            margin: 20px 0;
            padding: 20px;
            background: var(--primary-light);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
            border: 1px solid var(--border);
        }

        .season-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--card-bg);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .plant-effects {
            position: absolute;
            bottom: 15px;
            left: 15px;
            font-size: 1.8em;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            color: var(--primary-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        @keyframes grow {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .growing {
            animation: grow 0.5s ease;
        }

        .shaking {
            animation: shake 0.5s ease;
        }

        .tool-tip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: var(--card-bg);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }

        .tool:hover .tool-tip {
            opacity: 1;
        }

        .petals-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .info-section {
            margin: 25px 0;
        }

        .info-section h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-section ul {
            list-style: none;
            padding-left: 0;
        }

        .info-section li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section li:before {
            content: "🌱";
            font-size: 1.2em;
        }

        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }
            
            .user-details {
                align-items: center;
            }
            
            .nav-menu {
                margin-left: 0;
                justify-content: center;
                flex-wrap: wrap;
            }

            .plant-info {
                position: static;
            }

            .plant-needs {
                grid-template-columns: 1fr;
            }

            .care-tools {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .plant-stats {
                grid-template-columns: 1fr;
            }
            
            .care-tools {
                grid-template-columns: 1fr;
            }
            
            .plant-image {
                font-size: 6em;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="window.location.href='main-site.html'">
            <div class="logo-icon">🌿</div>
            <div class="logo-text">Plant Care</div>
        </div>
        <div>
            <button class="btn btn-secondary" onclick="window.location.href='games.html'">
                <i class="fas fa-arrow-left"></i> Назад
            </button>
            <button class="btn btn-primary" onclick="nextPlant()">
                Следующее растение <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </header>

    <div class="game-container">
        <div class="plant-info">
            <h2 id="plantName">Подсолнух</h2>
            <div class="plant-stats">
                <div class="stat">
                    <div class="stat-value" id="plantHealth">100%</div>
                    <div>Здоровье</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="plantLevel">1</div>
                    <div>Уровень</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="carePoints">0</div>
                    <div>Очки ухода</div>
                </div>
            </div>

            <div class="progress-container">
                <div>Прогресс уровня: <span id="expText">0/100</span></div>
                <div class="level-bar">
                    <div class="level-progress" id="levelProgress" style="width: 0%"></div>
                    <div class="level-text" id="levelText">0%</div>
                </div>
            </div>

            <div class="plant-evolution">
                <strong>Следующая эволюция:</strong>
                <div id="nextEvolution">Уровень 2 - Новые возможности ухода!</div>
            </div>

            <h3>О растении</h3>
            <p id="plantDescription">Подсолнух - солнечное растение, которое требует много света и регулярного полива.</p>

            <h3>Особенности ухода</h3>
            <ul id="plantTips">
                <li>Любит солнечные места</li>
                <li>Требует регулярного полива</li>
                <li>Удобрять раз в 2 недели</li>
            </ul>

            <div class="achievements">
                <h3>Достижения</h3>
                <div id="achievementsList"></div>
            </div>
        </div>

        <div class="care-area">
            <div class="plant-display">
                <div class="season-indicator" id="seasonIndicator">🌞 Лето</div>
                <div class="plant-image" id="plantImage">🌻</div>
                <div class="plant-mood" id="plantMood"></div>
                <div class="plant-effects" id="plantEffects"></div>
            </div>

            <div class="plant-needs">
                <div class="need-item">
                    <div class="need-icon">💧</div>
                    <div>Полив</div>
                    <div class="need-bar">
                        <div class="need-progress water-progress" id="waterNeed" style="width: 100%"></div>
                    </div>
                    <div id="waterStatus">Отлично</div>
                </div>
                <div class="need-item">
                    <div class="need-icon">🌞</div>
                    <div>Свет</div>
                    <div class="need-bar">
                        <div class="need-progress light-progress" id="lightNeed" style="width: 100%"></div>
                    </div>
                    <div id="lightStatus">Отлично</div>
                </div>
                <div class="need-item">
                    <div class="need-icon">🍃</div>
                    <div>Удобрения</div>
                    <div class="need-bar">
                        <div class="need-progress food-progress" id="foodNeed" style="width: 100%"></div>
                    </div>
                    <div id="foodStatus">Отлично</div>
                </div>
                <div class="need-item">
                    <div class="need-icon">❤️</div>
                    <div>Забота</div>
                    <div class="need-bar">
                        <div class="need-progress love-progress" id="loveNeed" style="width: 100%"></div>
                    </div>
                    <div id="loveStatus">Отлично</div>
                </div>
            </div>

            <div class="care-tools">
                <button class="tool" onclick="careForPlant('water')" id="waterTool">
                    <div style="font-size: 2em;">💧</div>
                    <div>Полить</div>
                    <div class="tool-tip">Восстанавливает влагу</div>
                </button>
                <button class="tool" onclick="careForPlant('light')" id="lightTool">
                    <div style="font-size: 2em;">💡</div>
                    <div>Осветить</div>
                    <div class="tool-tip">Увеличивает освещение</div>
                </button>
                <button class="tool" onclick="careForPlant('food')" id="foodTool">
                    <div style="font-size: 2em;">🌱</div>
                    <div>Удобрить</div>
                    <div class="tool-tip">Добавляет питательные вещества</div>
                </button>
                <button class="tool" onclick="careForPlant('love')" id="loveTool">
                    <div style="font-size: 2em;">❤️</div>
                    <div>Погладить</div>
                    <div class="tool-tip">Повышает настроение растения</div>
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        Уход успешен! +10 очков
    </div>

    <script>
        const plants = [
            {
                id: 1,
                name: "Подсолнух",
                icon: "🌻",
                description: "Солнечный цветок, который поворачивается к солнцу. Требует много света и тепла.",
                tips: ["Поливать утром", "Любит прямые солнечные лучи", "Удобрять в период роста"],
                needs: { water: 80, light: 90, food: 70, love: 60 },
                decayRates: { water: 3, light: 1, food: 2, love: 1 }
            },
            {
                id: 2, 
                name: "Роза",
                icon: "🌹",
                description: "Королева цветов. Требует внимательного ухода и защиты от вредителей.",
                tips: ["Поливать под корень", "Обрезать сухие ветки", "Защищать от тли"],
                needs: { water: 70, light: 80, food: 85, love: 75 },
                decayRates: { water: 2, light: 2, food: 1, love: 2 }
            },
            {
                id: 3,
                name: "Кактус",
                icon: "🌵", 
                description: "Неприхотливое растение, идеальное для начинающих садоводов.",
                tips: ["Редкий полив", "Много света", "Не переувлажнять"],
                needs: { water: 30, light: 95, food: 40, love: 50 },
                decayRates: { water: 1, light: 1, food: 1, love: 1 }
            },
            {
                id: 4,
                name: "Орхидея",
                icon: "🌸",
                description: "Экзотический цветок, требующий особых условий содержания.",
                tips: ["Полив методом погружения", "Рассеянный свет", "Специальный субстрат"],
                needs: { water: 65, light: 75, food: 80, love: 85 },
                decayRates: { water: 2, light: 2, food: 3, love: 2 }
            },
            {
                id: 5,
                name: "Бонсай",
                icon: "🎋",
                description: "Миниатюрное дерево, искусство выращивания которого требует терпения.",
                tips: ["Регулярная обрезка", "Умеренный полив", "Специальные удобрения"],
                needs: { water: 60, light: 70, food: 75, love: 90 },
                decayRates: { water: 2, light: 1, food: 2, love: 3 }
            }
        ];

        const seasons = [
            { name: "🌱 Весна", effect: { water: 1, light: 1, food: 1.2, love: 1 } },
            { name: "🌞 Лето", effect: { water: 1.3, light: 1.2, food: 1, love: 1 } },
            { name: "🍂 Осень", effect: { water: 0.8, light: 0.7, food: 1, love: 1.1 } },
            { name: "❄️ Зима", effect: { water: 0.6, light: 0.5, food: 0.8, love: 1.2 } }
        ];

        let currentPlantIndex = 0;
        let currentSeasonIndex = 0;
        let plantState = {
            water: 100,
            light: 100,
            food: 100,
            love: 100,
            health: 100,
            level: 1,
            experience: 0,
            carePoints: 0,
            totalCares: 0,
            evolutionStage: 0
        };

        let careCooldowns = {
            water: 0,
            light: 0,
            food: 0,
            love: 0
        };

        let needsInterval;
        let seasonInterval;

        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            loadPlantData();
            startNeedsDecay();
            startSeasonCycle();
            updateDisplay();
            loadAchievements();
            updateToolCooldowns();
        });

        function loadPlantData() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userData = users.find(u => u.email === currentUser.email);
            
            if (userData && userData.plantCare) {
                plantState = { ...plantState, ...userData.plantCare };
                currentPlantIndex = userData.plantCare.currentPlantIndex || 0;
                currentSeasonIndex = userData.plantCare.currentSeasonIndex || 0;
            }
        }

        function savePlantData() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex !== -1) {
                if (!users[userIndex].plantCare) {
                    users[userIndex].plantCare = {};
                }
                users[userIndex].plantCare = { 
                    ...plantState, 
                    currentPlantIndex, 
                    currentSeasonIndex 
                };
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function startNeedsDecay() {
            clearInterval(needsInterval);
            needsInterval = setInterval(() => {
                const plant = plants[currentPlantIndex];
                const season = seasons[currentSeasonIndex];
                
                // Уменьшаем потребности с учетом сезона и типа растения
                plantState.water = Math.max(0, plantState.water - plant.decayRates.water * season.effect.water);
                plantState.light = Math.max(0, plantState.light - plant.decayRates.light * season.effect.light);
                plantState.food = Math.max(0, plantState.food - plant.decayRates.food * season.effect.food);
                plantState.love = Math.max(0, plantState.love - plant.decayRates.love * season.effect.love);
                
                updateHealth();
                updateDisplay();
                savePlantData();
                
                // Проверяем критические состояния
                checkCriticalStates();
            }, 8000); // Каждые 8 секунд
        }

        function startSeasonCycle() {
            clearInterval(seasonInterval);
            seasonInterval = setInterval(() => {
                currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
                updateDisplay();
                showNotification(`Смена сезона: ${seasons[currentSeasonIndex].name}`, 'warning');
            }, 60000); // Смена сезона каждую минуту
        }

        function updateHealth() {
            const weights = { water: 0.3, light: 0.25, food: 0.25, love: 0.2 };
            const weightedHealth = 
                (plantState.water * weights.water) +
                (plantState.light * weights.light) +
                (plantState.food * weights.food) +
                (plantState.love * weights.love);
            
            plantState.health = Math.max(0, Math.min(100, weightedHealth));
        }

        function careForPlant(type) {
            if (careCooldowns[type] > 0) {
                showNotification(`Подождите ${careCooldowns[type]}с перед следующим уходом!`, 'error');
                return;
            }

            const plant = plants[currentPlantIndex];
            const careValues = {
                water: 25 + plant.level * 5,
                light: 20 + plant.level * 4,
                food: 30 + plant.level * 6,
                love: 15 + plant.level * 3
            };

            const bonus = plantState.level >= 5 ? 1.2 : 1;
            const value = Math.min(100, plantState[type] + careValues[type] * bonus);

            plantState[type] = value;
            plantState.carePoints += 10;
            plantState.totalCares += 1;
            plantState.experience += 15;

            // Анимация
            const plantImage = document.getElementById('plantImage');
            plantImage.classList.add('growing');
            setTimeout(() => plantImage.classList.remove('growing'), 500);

            // Проверка уровня
            checkLevelUp();

            // Установка кулдауна
            careCooldowns[type] = 3; // 3 секунды
            updateToolCooldowns();

            showNotification(`Уход успешен! +15 опыта`, 'success');
            updateDisplay();
            savePlantData();
            checkAchievements();
        }

        function updateToolCooldowns() {
            Object.keys(careCooldowns).forEach(type => {
                const tool = document.getElementById(`${type}Tool`);
                if (careCooldowns[type] > 0) {
                    tool.disabled = true;
                    let cooldown = careCooldowns[type];
                    
                    const cooldownInterval = setInterval(() => {
                        if (cooldown <= 0) {
                            tool.disabled = false;
                            tool.innerHTML = tool.innerHTML.replace(/<div class="cooldown-overlay">.*?<\/div>/, '');
                            clearInterval(cooldownInterval);
                            return;
                        }
                        
                        const existingOverlay = tool.querySelector('.cooldown-overlay');
                        if (existingOverlay) {
                            existingOverlay.textContent = cooldown;
                        } else {
                            const overlay = document.createElement('div');
                            overlay.className = 'cooldown-overlay';
                            overlay.textContent = cooldown;
                            tool.appendChild(overlay);
                        }
                        
                        cooldown--;
                    }, 1000);
                }
            });
        }

        function checkLevelUp() {
            const expNeeded = plantState.level * 100;
            if (plantState.experience >= expNeeded) {
                plantState.level++;
                plantState.experience = 0;
                
                // Эволюция растения
                if (plantState.level % 3 === 0) {
                    plantState.evolutionStage++;
                    showNotification(`🎉 Эволюция! Растение достигло новой стадии развития!`, 'success');
                }
                
                showNotification(`🎉 Новый уровень: ${plantState.level}`, 'success');
                updateDisplay();
            }
        }

        function checkCriticalStates() {
            if (plantState.water < 20) {
                showNotification(`💧 Растение сильно хочет пить!`, 'warning');
            }
            if (plantState.light < 20) {
                showNotification(`🌞 Растению не хватает света!`, 'warning');
            }
            if (plantState.food < 20) {
                showNotification(`🍃 Растение нуждается в удобрениях!`, 'warning');
            }
            if (plantState.health < 30) {
                showNotification(`🚨 Растение в критическом состоянии!`, 'error');
            }
        }

        function updateDisplay() {
            const plant = plants[currentPlantIndex];
            const season = seasons[currentSeasonIndex];
            
            // Обновляем информацию о растении
            document.getElementById('plantName').textContent = plant.name;
            document.getElementById('plantImage').textContent = plant.icon;
            document.getElementById('plantDescription').textContent = plant.description;
            document.getElementById('seasonIndicator').textContent = season.name;
            
            // Обновляем статистику
            document.getElementById('plantHealth').textContent = Math.round(plantState.health) + '%';
            document.getElementById('plantLevel').textContent = plantState.level;
            document.getElementById('carePoints').textContent = plantState.carePoints;
            
            // Обновляем прогресс уровня
            const expNeeded = plantState.level * 100;
            const progressPercent = (plantState.experience / expNeeded) * 100;
            document.getElementById('levelProgress').style.width = progressPercent + '%';
            document.getElementById('levelText').textContent = Math.round(progressPercent) + '%';
            document.getElementById('expText').textContent = `${plantState.experience}/${expNeeded}`;
            
            // Обновляем информацию об эволюции
            document.getElementById('nextEvolution').textContent = 
                plantState.level < 15 ? `Уровень ${plantState.level + 1} - Новые возможности!` : 'Максимальный уровень достигнут!';
            
            // Обновляем потребности
            document.getElementById('waterNeed').style.width = plantState.water + '%';
            document.getElementById('lightNeed').style.width = plantState.light + '%';
            document.getElementById('foodNeed').style.width = plantState.food + '%';
            document.getElementById('loveNeed').style.width = plantState.love + '%';
            
            // Обновляем статусы
            document.getElementById('waterStatus').textContent = getStatusText(plantState.water);
            document.getElementById('lightStatus').textContent = getStatusText(plantState.light);
            document.getElementById('foodStatus').textContent = getStatusText(plantState.food);
            document.getElementById('loveStatus').textContent = getStatusText(plantState.love);
            
            // Обновляем советы по уходу
            const tipsList = document.getElementById('plantTips');
            tipsList.innerHTML = '';
            plant.tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsList.appendChild(li);
            });
            
            // Обновляем настроение и эффекты растения
            updatePlantMood();
            updatePlantEffects();
        }

        function getStatusText(value) {
            if (value >= 80) return 'Отлично';
            if (value >= 60) return 'Хорошо';
            if (value >= 40) return 'Нормально';
            if (value >= 20) return 'Плохо';
            return 'Критично';
        }

        function updatePlantMood() {
            const moodElement = document.getElementById('plantMood');
            const health = plantState.health;
            
            if (health >= 80) {
                moodElement.textContent = '😊 Растение счастливо!';
                moodElement.style.background = '#c8e6c9';
            } else if (health >= 60) {
                moodElement.textContent = '🙂 Растение довольно';
                moodElement.style.background = '#e8f5e9';
            } else if (health >= 40) {
                moodElement.textContent = '😐 Растение нуждается в уходе';
                moodElement.style.background = '#fff3e0';
            } else if (health >= 20) {
                moodElement.textContent = '😟 Растение плохо себя чувствует';
                moodElement.style.background = '#ffebee';
            } else {
                moodElement.textContent = '😵 Растение в критическом состоянии!';
                moodElement.style.background = '#ffcdd2';
            }
        }

        function updatePlantEffects() {
            const effectsElement = document.getElementById('plantEffects');
            effectsElement.innerHTML = '';
            
            if (plantState.level >= 3) {
                effectsElement.innerHTML += '✨';
            }
            if (plantState.level >= 6) {
                effectsElement.innerHTML += '🌟';
            }
            if (plantState.level >= 9) {
                effectsElement.innerHTML += '💫';
            }
        }

        function nextPlant() {
            currentPlantIndex = (currentPlantIndex + 1) % plants.length;
            showNotification(`Переключено на: ${plants[currentPlantIndex].name}`, 'success');
            updateDisplay();
            savePlantData();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function loadAchievements() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userData = users.find(u => u.email === currentUser.email);
            const achievements = userData?.achievements || [];
            
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            
            const plantAchievements = [
                { id: 'care_1', name: 'Первый уход', icon: '🌱', desc: 'Позаботьтесь о растении впервые' },
                { id: 'care_50', name: 'Опытный садовод', icon: '👨‍🌾', desc: 'Выполните 50 уходов' },
                { id: 'care_100', name: 'Мастер ухода', icon: '🏆', desc: 'Выполните 100 уходов' },
                { id: 'level_5', name: 'Растущий садовод', icon: '📈', desc: 'Достигните 5 уровня' },
                { id: 'level_10', name: 'Эксперт растений', icon: '🎓', desc: 'Достигните 10 уровня' },
                { id: 'evolution_1', name: 'Первая эволюция', icon: '🔬', desc: 'Достигните 3 уровня' },
                { id: 'all_plants', name: 'Коллекционер', icon: '🌿', desc: 'Ухаживайте за всеми растениями' }
            ];
            
            plantAchievements.forEach(ach => {
                const achieved = achievements.includes(ach.id);
                const div = document.createElement('div');
                div.className = 'achievement' + (achieved ? ' achieved' : '');
                div.innerHTML = `
                    <span style="font-size: 1.5em;">${ach.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${ach.name}</div>
                        <small style="color: #666;">${ach.desc}</small>
                    </div>
                    ${achieved ? '<span style="color: #4caf50; font-size: 1.2em;">✓</span>' : 
                                '<span style="color: #ccc; font-size: 1.2em;">○</span>'}
                `;
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.background = achieved ? '#e8f5e9' : '#f5f5f5';
                div.style.borderRadius = '8px';
                div.style.border = achieved ? '2px solid #4caf50' : '2px solid transparent';
                
                achievementsList.appendChild(div);
            });
        }

        function checkAchievements() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex === -1) return;
            
            if (!users[userIndex].achievements) {
                users[userIndex].achievements = [];
            }
            
            const achievements = users[userIndex].achievements;
            const newAchievements = [];
            
            // Проверяем достижения
            if (plantState.totalCares >= 1 && !achievements.includes('care_1')) {
                achievements.push('care_1');
                newAchievements.push('Первый уход');
            }
            
            if (plantState.totalCares >= 50 && !achievements.includes('care_50')) {
                achievements.push('care_50');
                newAchievements.push('Опытный садовод');
            }
            
            if (plantState.totalCares >= 100 && !achievements.includes('care_100')) {
                achievements.push('care_100');
                newAchievements.push('Мастер ухода');
            }
            
            if (plantState.level >= 5 && !achievements.includes('level_5')) {
                achievements.push('level_5');
                newAchievements.push('Растущий садовод');
            }
            
            if (plantState.level >= 10 && !achievements.includes('level_10')) {
                achievements.push('level_10');
                newAchievements.push('Эксперт растений');
            }
            
            if (plantState.level >= 3 && !achievements.includes('evolution_1')) {
                achievements.push('evolution_1');
                newAchievements.push('Первая эволюция');
            }
            
            // Проверяем уход за всеми растениями
            const plantCares = users[userIndex].plantCares || {};
            const allPlantsCared = plants.every(plant => plantCares[plant.id] > 0);
            if (allPlantsCared && !achievements.includes('all_plants')) {
                achievements.push('all_plants');
                newAchievements.push('Коллекционер');
            }
            
            if (newAchievements.length > 0) {
                localStorage.setItem('users', JSON.stringify(users));
                showNotification('🎉 Новые достижения: ' + newAchievements.join(', '));
                loadAchievements();
                
                // Обновляем глобальную систему
                if (window.gameSystem) {
                    newAchievements.forEach(() => {
                        window.gameSystem.checkAchievement('plant_master', true);
                    });
                }
            }
        }

        // Сохраняем данные при закрытии страницы
        window.addEventListener('beforeunload', savePlantData);
    </script>
    <script>
// Общий код для применения темы на всех страницах
function applyThemeSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
    
    if (settings.theme) {
        document.body.setAttribute('data-theme', settings.theme);
        
        // Применяем dark mode для не-темных тем
        if (settings.darkMode && settings.theme !== 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
    
    // Применяем настройки шрифта если есть
    if (settings.fontSize) {
        document.body.style.fontSize = settings.fontSize + 'px';
    }
    if (settings.fontFamily) {
        document.body.style.fontFamily = settings.fontFamily + ', sans-serif';
    }
}

// Применяем настройки при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    applyThemeSettings();
});
</script>
</body>
</html>