<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Друзья - Garden Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="js/settings-manager.js"></script>
    <script src="theme-manager.js"></script>
    <script src="lang.js"></script>
    <style>
        [data-theme="dark"] {
            --primary: #66bb6a;
            --primary-dark: #388e3c;
            --primary-light: #1b5e20;
            --text: #ffffff;
            --text-light: #b0b0b0;
            --background: #121212;
            --card-bg: #1e1e1e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #333333;
        }

        [data-theme="green"] {
            --primary: #4CAF50;
            --primary-dark: #2E7D32;
            --primary-light: #E8F5E9;
            --text: #1B5E20;
            --text-light: #4CAF50;
            --background: #F1F8E9;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(76, 175, 80, 0.15);
            --border: #C8E6C9;
        }

        [data-theme="blue"] {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --text: #0D47A1;
            --text-light: #2196F3;
            --background: #E3F2FD;
            --card-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
            --border: #BBDEFB;
        }

        [data-theme="green"].dark-mode {
            --primary: #66bb6a;
            --primary-dark: #388e3c;
            --primary-light: #1b5e20;
            --text: #e8f5e9;
            --text-light: #a5d6a7;
            --background: #1b311c;
            --card-bg: #2e4630;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #1b5e20;
        }

        [data-theme="blue"].dark-mode {
            --primary: #64b5f6;
            --primary-dark: #1976d2;
            --primary-light: #0d47a1;
            --text: #e3f2fd;
            --text-light: #90caf9;
            --background: #0d1b33;
            --card-bg: #1e2b47;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --border: #1565c0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
        }

        body {
            background: var(--background);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            color: var(--text);
            transition: all 0.3s ease;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 2;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-dark);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logo-icon {
            font-size: 2em;
            color: var(--primary);
        }

.nav-menu {
            display: flex;
            gap: 20px;
            margin-right: 510px;
        }

        .nav-item {
            padding: 10px 20px;
            border-radius: 12px;
            color: var(--primary-dark);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(241, 248, 233, 0.7);
            transform: translateY(-2px);
        }
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .nav-item.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }


        .friends-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .friends-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .friends-title {
            font-family: 'Playfair Display', serif;
            font-size: 3em;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .friend-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .friend-card:hover {
            transform: translateY(-5px);
        }

        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
        }

        .friend-name {
            font-size: 1.2em;
            color: var(--text);
            margin-bottom: 5px;
        }

        .friend-level {
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .friend-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-light);
        }

        .friend-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .search-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 5px;
            background: var(--card-bg);
            color: var(--text);
        }

        .message-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .messages-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }

        .message {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.own {
            background: var(--primary-light);
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .message.friend {
            background: var(--card-bg);
            border: 1px solid var(--border);
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        .message-sender {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9em;
        }

        .message-text {
            margin: 5px 0;
        }

        .message-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 5px;
            margin-bottom: 10px;
            background: var(--card-bg);
            color: var(--text);
        }

        .empty-state {
            text-align: center;
            color: var(--text-light);
            padding: 40px;
        }

        .online-status {
            margin-top: 10px;
            font-size: 0.9em;
        }

        .online {
            color: #4caf50;
        }

        .offline {
            color: #666;
        }

        .typing-indicator {
            color: var(--text-light);
            font-style: italic;
            font-size: 0.9em;
            margin: 5px 0;
            padding: 10px;
            display: none;
        }

        .message-time {
            font-size: 0.8em;
            color: var(--text-light);
            text-align: right;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .back-button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2em;
        }

        .status-change-notification {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin: 5px 0;
            text-align: center;
            font-style: italic;
        }

        .group-chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .group-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
        }

        .group-info {
            flex: 1;
        }

        .group-members {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
        }

        .message.system {
            background: var(--primary-light);
            color: var(--primary-dark);
            text-align: center;
            font-style: italic;
            margin: 10px auto;
            max-width: 60%;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .group-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .group-option {
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .group-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .message-input-group {
            display: flex;
            gap: 10px;
        }

        .group-members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .member-tag {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="window.location.href='main-site.html'">
            <div class="logo-icon">🌿</div>
            <div class="logo-text">Garden Game</div>
        </div>
        
        <div class="nav-menu">
            <a href="main-site.html" class="nav-item">Главная</a>
            <a href="profile.html" class="nav-item">Профиль</a>
            <a href="shop.html" class="nav-item">Магазин</a>
            <a href="friends.html" class="nav-item active">Друзья</a>
            <a href="games.html" class="nav-item">Игры</a>
            <a href="settings.html" class="nav-item">Настройки</a>
        </div>
    </header>

    <div class="friends-container">
        <div class="friends-header">
            <h1 class="friends-title">Сообщество друзей</h1>
            <p>Находите новых друзей, общайтесь и соревнуйтесь вместе</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('friends')">Мои друзья</button>
            <button class="tab" onclick="showTab('search')">Найти друзей</button>
            <button class="tab" onclick="showTab('messages')">Сообщения</button>
            <button class="tab" onclick="showTab('group')">Групповой чат</button>
        </div>

        <div id="friendsTab" class="tab-content">
            <div class="friends-grid" id="friendsGrid">
                <!-- Друзья будут загружены через JavaScript -->
            </div>
        </div>

        <div id="searchTab" class="tab-content" style="display: none;">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Введите имя пользователя">
                    <button class="btn btn-primary" onclick="searchUsers()">Поиск</button>
                </div>
            </div>
            <div class="friends-grid" id="searchResults">
                <!-- Результаты поиска -->
            </div>
        </div>

        <div id="messagesTab" class="tab-content" style="display: none;">
            <div class="message-section">
                <div id="chatHeader" class="chat-header" style="display: none;">
                    <button class="back-button" onclick="showFriendsList()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <div id="currentFriendName" style="font-weight: bold;"></div>
                        <div id="currentFriendStatus" class="online-status"></div>
                    </div>
                </div>
                <div class="messages-list" id="messagesList">
                    <!-- Сообщения будут загружены через JavaScript -->
                </div>
                <div id="typingIndicator" class="typing-indicator"></div>
                <div id="messageInputContainer" style="display: none;">
                    <input type="text" class="message-input" id="messageInput" placeholder="Введите сообщение..." onkeypress="handleMessageKeypress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">Отправить</button>
                </div>
            </div>
        </div>

        <div id="groupTab" class="tab-content" style="display: none;">
            <div class="message-section">
                <div class="group-chat-header">
                    <div class="group-avatar">👥</div>
                    <div class="group-info">
                        <div style="font-weight: bold;" id="groupTitle">Садовая беседка</div>
                        <div class="group-members">
                            Участники: <span id="groupMembersCount">0</span>
                            <div class="group-members-list" id="groupMembersList"></div>
                        </div>
                    </div>
                </div>
                
                <div class="group-selector">
                    <div class="group-option active" onclick="switchGroup('garden')">Садовая беседка</div>
                    <div class="group-option" onclick="switchGroup('plants')">Любители растений</div>
                    <div class="group-option" onclick="switchGroup('tips')">Советы по садоводству</div>
                    <div class="group-option" onclick="switchGroup('newbies')">Новички в садоводстве</div>
                    <div class="group-option" onclick="switchGroup('experts')">Эксперты садоводы</div>
                </div>
                
                <div class="messages-list" id="groupMessagesList">
                    <!-- Групповые сообщения будут загружены через JavaScript -->
                </div>
                <div id="groupTypingIndicator" class="typing-indicator"></div>
                <div class="message-input-group">
                    <input type="text" class="message-input" id="groupMessageInput" placeholder="Введите сообщение для группы..." onkeypress="handleGroupMessageKeypress(event)">
                    <button class="btn btn-primary" onclick="sendGroupMessage()">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentTab = 'friends';
        let selectedFriend = null;
        let currentGroup = 'garden';

        // Расширенный список демонстрационных пользователей
        const demoUsers = [
            { 
                username: "Садовник", 
                email: "gardener@example.com",
                level: 5, 
                plants: 23, 
                friends: 15, 
                online: true,
                avatar: "🌿",
                lastSeen: "только что",
                personality: "enthusiastic",
                responseDelay: 2000,
                interests: ["овощи", "томаты", "огурцы"]
            },
            { 
                username: "Цветовод", 
                email: "florist@example.com",
                level: 3, 
                plants: 15, 
                friends: 8, 
                online: true,
                avatar: "🌻",
                lastSeen: "только что",
                personality: "calm",
                responseDelay: 3000,
                interests: ["розы", "орхидеи", "лилии"]
            },
            { 
                username: "Флорист", 
                email: "floral@example.com",
                level: 7, 
                plants: 45, 
                friends: 22, 
                online: true,
                avatar: "🌸",
                lastSeen: "только что",
                personality: "creative",
                responseDelay: 1500,
                interests: ["композиции", "букеты", "дизайн"]
            },
            { 
                username: "Ландшафт", 
                email: "landscape@example.com",
                level: 4, 
                plants: 18, 
                friends: 10, 
                online: true,
                avatar: "🌳",
                lastSeen: "только что",
                personality: "professional",
                responseDelay: 2500,
                interests: ["деревья", "кустарники", "газоны"]
            },
            { 
                username: "Розочка", 
                email: "rose@example.com",
                level: 6, 
                plants: 32, 
                friends: 18, 
                online: true,
                avatar: "🌹",
                lastSeen: "только что",
                personality: "romantic",
                responseDelay: 3500,
                interests: ["розы", "пионы", "гортензии"]
            }
        ];

        // База ответов для разных персонажей
        const responseDatabase = {
            enthusiastic: [
                "Отлично! У меня тоже все прекрасно растет! 🌱",
                "О, это замечательно! Хочешь посмотреть мои новые растения?",
                "Как раз думал о том, чтобы посадить что-то новое!",
                "Ух ты! А у меня сегодня вырос первый помидор! 🍅",
                "Давай вместе посадим что-нибудь! У меня есть свободные горшки!",
                "Замечательная погода для садоводства, не правда ли? ☀️",
                "Только что полил все растения, они такие счастливые! 💧"
            ],
            calm: [
                "Приятно слышать. У меня все растет медленно, но верно.",
                "Спасибо, у меня тоже все хорошо. Растения требуют терпения.",
                "Интересно... А какие цветы ты предпочитаешь?",
                "У меня сегодня такой спокойный день в саду...",
                "Растения taught me patience. Everything in its own time.",
                "Просто наблюдаю за тем, как растут мои цветы. Это медитативно."
            ],
            creative: [
                "О! У меня появилась идея для новой цветочной композиции!",
                "Твои слова вдохновили меня на создание нового садового дизайна!",
                "Представляешь, если бы мы создали сад в стиле импрессионизма?",
                "Цвета твоего сада звучат потрясающе! Хочу увидеть фото!",
                "У меня есть креативная идея для нашего следующего проекта!",
                "Только что придумал новую схему посадки - будет очень необычно!"
            ],
            professional: [
                "Интересно. Какие удобрения ты используешь?",
                "Рекомендую попробовать новый метод полива - очень эффективно.",
                "У тебя хороший подход. Я бы добавил немного компоста.",
                "С точки зрения ландшафтного дизайна, это отличное решение.",
                "Заметил, что при таком уходе растения растут на 20% быстрее.",
                "Профессиональный совет: попробуй использовать капельный полив."
            ],
            romantic: [
                "Какая романтичная идея! Цветы - это язык любви...",
                "Мои розы сегодня пахнут особенно нежно... 🌹",
                "В саду так красиво, особенно при лунном свете...",
                "Каждый цветок рассказывает свою историю любви...",
                "Твои слова как утренняя роса на лепестках роз...",
                "Сад - это место, где расцветают не только цветы, но и чувства..."
            ]
        };

        // Расширенные ответы для группового чата
        const groupResponses = {
            garden: [
                "Кто-нибудь пробовал выращивать помидоры на балконе?",
                "У меня проблемы с тлей на розах, есть советы?",
                "Какие цветы лучше посадить в тенистом уголке сада?",
                "Поделитесь опытом выращивания орхидей!",
                "Как часто вы поливаете свои кактусы?",
                "Кто-нибудь использует гидропонику для растений?",
                "Какие удобрения вы считаете самыми эффективными?",
                "Поделитесь фотографиями своих садов! 🌸",
                "У кого-нибудь есть опыт с вертикальным озеленением?",
                "Какие растения лучше всего подходят для начинающих?"
            ],
            plants: [
                "У кого-нибудь есть опыт с бонсай?",
                "Какие комнатные растения самые неприхотливые?",
                "Кто знает хорошие сорта томатов для холодного климата?",
                "Поделитесь секретами выращивания авокадо из косточки!",
                "Какие растения лучше всего очищают воздух в квартире?",
                "У кого-нибудь есть опыт с хищными растениями?",
                "Какие многолетние цветы самые долгоцветущие?",
                "Кто выращивает экзотические растения?",
                "Какие лекарственные растения можно вырастить на подоконнике?",
                "Поделитесь опытом выращивания цитрусовых дома!"
            ],
            tips: [
                "Совет: не поливайте растения холодной водой!",
                "Обязательно делайте дренаж в горшках!",
                "Подкармливайте растения только в период роста.",
                "Регулярно проверяйте растения на наличие вредителей.",
                "Не ставьте растения рядом с батареями зимой.",
                "Используйте отстоянную воду для полива.",
                "Пересаживайте растения весной, перед началом роста.",
                "Обрезайте сухие листья и цветы регулярно.",
                "Рыхлите почву для лучшего доступа воздуха к корням.",
                "Используйте натуральные удобрения - они безопаснее!"
            ],
            newbies: [
                "С чего лучше начать новичку в садоводстве?",
                "Какие самые простые растения для первого опыта?",
                "Как часто нужно поливать комнатные растения?",
                "Что делать, если растение начало вянуть?",
                "Какие самые распространенные ошибки новичков?",
                "Нужно ли сразу покупать дорогие инструменты?",
                "Как выбрать правильный горшок для растения?",
                "Какая почва лучше подходит для начинающих?",
                "Как понять, что растению не хватает света?",
                "Сколько времени нужно уделять саду ежедневно?"
            ],
            experts: [
                "Кто использует системы капельного полива?",
                "Поделитесь опытом с гидропонными системами!",
                "Какие современные технологии в садоводстве вы используете?",
                "Как бороться с редкими видами вредителей?",
                "Кто занимается селекцией растений?",
                "Какие методы повышения урожайности самые эффективные?",
                "Поделитесь опытом с тепличным хозяйством!",
                "Как оптимизировать процессы в большом саду?",
                "Какие автоматизированные системы стоит использовать?",
                "Советы по ведению садоводческого бизнеса?"
            ]
        };

        // Общие ответы для всех персонажей
        const generalResponses = [
            "Как интересно! Расскажи подробнее!",
            "Ух ты! А у меня сегодня тоже кое-что новое!",
            "Спасибо, что поделился! Это вдохновляет!",
            "Отличная идея! Я тоже так думаю!",
            "Интересно... А как ты к этому пришел?",
            "Понятно. А что планируешь делать дальше?",
            "Здорово! Хочешь, покажу свои достижения?",
            "Молодец! Продолжай в том же духе!",
            "Это напоминает мне одну историю из моего сада...",
            "Как раз вовремя! У меня для тебя есть предложение!"
        ];

        // Названия групп
        const groupTitles = {
            garden: "Садовая беседка",
            plants: "Любители растений",
            tips: "Советы по садоводству",
            newbies: "Новички в садоводстве",
            experts: "Эксперты садоводы"
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Создаем тестового пользователя если нет текущего
            if (!sessionStorage.getItem('currentUser')) {
                const testUser = {
                    username: "ТестовыйПользователь",
                    email: "test@example.com",
                    level: 3,
                    plants: 12,
                    friends: 5
                };
                sessionStorage.setItem('currentUser', JSON.stringify(testUser));
            }
            
            currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            // Инициализируем демо-данные если их нет
            initializeDemoData();
            loadFriends();
            updateGroupMembers();
            
            // Автоматически запускаем групповой чат с активным общением
            startGroupChatActivity();
        });

        function initializeDemoData() {
            let users = JSON.parse(localStorage.getItem('users')) || [];
            
            // Если пользователей нет, создаем начальные данные
            if (users.length === 0) {
                // Добавляем текущего пользователя
                users.push({
                    ...currentUser,
                    password: "test123",
                    plants: [],
                    settings: {},
                    messages: [],
                    friends: [],
                    groupMessages: {
                        garden: [],
                        plants: [],
                        tips: [],
                        newbies: [],
                        experts: []
                    }
                });
                
                // Добавляем демо-пользователей
                demoUsers.forEach(demoUser => {
                    users.push({
                        ...demoUser,
                        password: "demo123",
                        plants: [],
                        settings: {},
                        messages: [],
                        friends: [],
                        groupMessages: {
                            garden: [],
                            plants: [],
                            tips: [],
                            newbies: [],
                            experts: []
                        }
                    });
                });
                
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Добавляем друзей к текущему пользователю если их нет
            const currentUserData = users.find(u => u.email === currentUser.email);
            if (currentUserData && (!currentUserData.friends || currentUserData.friends.length === 0)) {
                // Добавляем всех демо-пользователей как друзей
                currentUserData.friends = demoUsers.map(friend => ({
                    username: friend.username,
                    level: friend.level,
                    plants: friend.plants,
                    friends: friend.friends,
                    online: friend.online,
                    avatar: friend.avatar,
                    lastSeen: friend.lastSeen,
                    personality: friend.personality,
                    responseDelay: friend.responseDelay,
                    interests: friend.interests
                }));
                
                // Добавляем демо-сообщения если их нет
                if (!currentUserData.messages || currentUserData.messages.length === 0) {
                    currentUserData.messages = [
                        {
                            sender: "Садовник",
                            receiver: currentUser.username,
                            text: "Привет! Как твой сад поживает?",
                            time: "10:30",
                            date: "2024-01-15"
                        },
                        {
                            sender: currentUser.username,
                            receiver: "Садовник",
                            text: "Привет! Все отлично, только что посадил новые розы 🌹",
                            time: "10:32",
                            date: "2024-01-15"
                        },
                        {
                            sender: "Садовник",
                            receiver: currentUser.username,
                            text: "Круто! У меня тоже новые растения появились. Хочешь обменяться семенами?",
                            time: "10:35",
                            date: "2024-01-15"
                        },
                        {
                            sender: "Цветовод",
                            receiver: currentUser.username,
                            text: "Привет! Видела твои розы - они великолепны!",
                            time: "11:20",
                            date: "2024-01-15"
                        },
                        {
                            sender: "Флорист",
                            receiver: currentUser.username,
                            text: "Здравствуйте! Хотите создать цветочную композицию вместе?",
                            time: "14:15",
                            date: "2024-01-15"
                        }
                    ];
                }
                
                // Инициализируем групповые сообщения с активным общением
                if (!currentUserData.groupMessages.garden || currentUserData.groupMessages.garden.length === 0) {
                    currentUserData.groupMessages = {
                        garden: [
                            {
                                sender: "Садовник",
                                text: "Привет всем! Как ваши садовые дела?",
                                time: "09:15",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Цветовод",
                                text: "У меня зацвели первые тюльпаны! 🌷",
                                time: "09:20",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Флорист",
                                text: "Кто-нибудь хочет создать совместную клумбу?",
                                time: "09:25",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Ландшафт",
                                text: "Предлагаю обсудить планировку садов на этой неделе",
                                time: "10:00",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Розочка",
                                text: "Мои розы сегодня особенно ароматны! 🌹",
                                time: "10:15",
                                date: "2024-01-15"
                            },
                            {
                                sender: "system",
                                text: "Все друзья теперь в групповом чате!",
                                time: "10:30",
                                date: "2024-01-15"
                            }
                        ],
                        plants: [
                            {
                                sender: "Садовник",
                                text: "Какие сорта томатов лучше всего подходят для балкона?",
                                time: "08:45",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Цветовод",
                                text: "У меня коллекция из 35 кактусов! Кто еще увлекается суккулентами?",
                                time: "09:10",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Флорист",
                                text: "Попробуйте выращивать микрозелень - это быстро и полезно!",
                                time: "09:30",
                                date: "2024-01-15"
                            }
                        ],
                        tips: [
                            {
                                sender: "Ландшафт",
                                text: "Совет: используйте яичную скорлупу как натуральное удобрение!",
                                time: "07:30",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Розочка",
                                text: "Не забывайте про мульчирование - это сохраняет влагу и защищает корни",
                                time: "08:15",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Садовник",
                                text: "Поливайте растения утром - это предотвращает грибковые заболевания",
                                time: "08:45",
                                date: "2024-01-15"
                            }
                        ],
                        newbies: [
                            {
                                sender: "Цветовод",
                                text: "С чего лучше начать новичку в садоводстве?",
                                time: "10:00",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Флорист",
                                text: "Начните с неприхотливых растений - сансевиерии или замиокулькаса",
                                time: "10:15",
                                date: "2024-01-15"
                            }
                        ],
                        experts: [
                            {
                                sender: "Ландшафт",
                                text: "Кто использует системы капельного полива?",
                                time: "11:00",
                                date: "2024-01-15"
                            },
                            {
                                sender: "Розочка",
                                text: "Поделитесь опытом с гидропонными системами!",
                                time: "11:20",
                                date: "2024-01-15"
                            }
                        ]
                    };
                }
                
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function startGroupChatActivity() {
            // Запускаем автоматическое общение в групповых чатах
            setInterval(() => {
                if (currentTab === 'group') {
                    generateRandomGroupMessage();
                }
            }, 15000); // Каждые 15 секунд
        }

        function generateRandomGroupMessage() {
            const responses = groupResponses[currentGroup] || [];
            if (responses.length === 0) return;

            const randomFriend = demoUsers[Math.floor(Math.random() * demoUsers.length)];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex !== -1 && users[userIndex].groupMessages) {
                const groupMessage = {
                    sender: randomFriend.username,
                    text: randomResponse,
                    time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toISOString().split('T')[0]
                };
                
                users[userIndex].groupMessages[currentGroup].push(groupMessage);
                localStorage.setItem('users', JSON.stringify(users));
                
                if (currentTab === 'group') {
                    loadGroupMessages();
                }
            }
        }

        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';

            if (tabName === 'friends') {
                showFriendsList();
            }
            if (tabName === 'messages') {
                if (selectedFriend) {
                    loadMessages();
                } else {
                    showFriendsList();
                }
            }
            if (tabName === 'group') {
                loadGroupMessages();
            }
        }

        function showFriendsList() {
            selectedFriend = null;
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('messageInputContainer').style.display = 'none';
            document.getElementById('messagesList').innerHTML = `
                <div class="empty-state">
                    <h3>Выберите друга для общения</h3>
                    <p>Нажмите "Чат" на карточке друга чтобы начать диалог</p>
                </div>
            `;
        }

        function loadFriends() {
            const grid = document.getElementById('friendsGrid');
            grid.innerHTML = '';

            const userData = getUserData();
            const friends = userData.friends || [];

            if (friends.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>У вас пока нет друзей</h3>
                        <p>Найдите друзей на вкладке "Поиск"</p>
                    </div>
                `;
                return;
            }

            friends.forEach(friend => {
                const card = document.createElement('div');
                card.className = 'friend-card';
                card.innerHTML = `
                    <div class="friend-avatar">${friend.avatar || friend.username.charAt(0)}</div>
                    <div class="friend-name">${friend.username}</div>
                    <div class="friend-level">Уровень ${friend.level}</div>
                    <div class="friend-stats">
                        <div class="stat">
                            <div class="stat-value">${friend.plants}</div>
                            <div class="stat-label">Растения</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${friend.friends}</div>
                            <div class="stat-label">Друзья</div>
                        </div>
                    </div>
                    <div class="online-status ${friend.online ? 'online' : 'offline'}">
                        ${friend.online ? '🟢 В сети' : `⚫ ${friend.lastSeen || 'Не в сети'}`}
                    </div>
                    <div class="friend-actions">
                        <button class="btn btn-primary" onclick="startChat('${friend.username}')">
                            <i class="fas fa-comment"></i> Чат
                        </button>
                        <button class="btn btn-secondary" onclick="removeFriend('${friend.username}')">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function startChat(username) {
            selectedFriend = username;
            showTab('messages');
            loadMessages();
        }

        function loadMessages() {
            const messagesList = document.getElementById('messagesList');
            const chatHeader = document.getElementById('chatHeader');
            const messageInputContainer = document.getElementById('messageInputContainer');

            if (!selectedFriend) {
                showFriendsList();
                return;
            }

            // Показываем заголовок чата и поле ввода
            chatHeader.style.display = 'flex';
            messageInputContainer.style.display = 'block';
            
            const friend = getUserData().friends?.find(f => f.username === selectedFriend);
            document.getElementById('currentFriendName').textContent = selectedFriend;
            document.getElementById('currentFriendStatus').innerHTML = 
                friend?.online ? '🟢 В сети' : `⚫ ${friend?.lastSeen || 'Не в сети'}`;

            messagesList.innerHTML = '';

            const userData = getUserData();
            const messages = userData.messages || [];
            
            // Фильтруем сообщения для текущего диалога
            const chatMessages = messages.filter(msg => 
                (msg.sender === selectedFriend && msg.receiver === currentUser.username) ||
                (msg.sender === currentUser.username && msg.receiver === selectedFriend)
            );

            if (chatMessages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state">
                        <h3>Нет сообщений с ${selectedFriend}</h3>
                        <p>Напишите первое сообщение!</p>
                    </div>
                `;
                return;
            }

            chatMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender === currentUser.username ? 'own' : 'friend'}`;
                messageDiv.innerHTML = `
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${message.time}</div>
                `;
                messagesList.appendChild(messageDiv);
            });

            // Прокручиваем к последнему сообщению
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && selectedFriend) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                
                if (userIndex !== -1) {
                    if (!users[userIndex].messages) {
                        users[userIndex].messages = [];
                    }
                    
                    const newMessage = {
                        sender: currentUser.username,
                        receiver: selectedFriend,
                        text: message,
                        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    users[userIndex].messages.push(newMessage);
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    messageInput.value = '';
                    loadMessages();
                    
                    // Показываем индикатор набора текста
                    showTypingIndicator(selectedFriend);
                    
                    // Запускаем ответ друга (быстрый ответ)
                    setTimeout(() => generateFriendResponse(selectedFriend, message), 1000);
                }
            } else if (!selectedFriend) {
                alert('Выберите друга для отправки сообщения!');
            }
        }

        function showTypingIndicator(friendName) {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.textContent = `${friendName} печатает...`;
            typingIndicator.style.display = 'block';
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
            }, 1500);
        }

        function generateFriendResponse(friendName, userMessage) {
            const friend = demoUsers.find(f => f.username === friendName);
            if (!friend) return;

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex === -1) return;

            // Получаем персонализированные ответы
            const personalityResponses = responseDatabase[friend.personality] || [];
            const allResponses = [...personalityResponses, ...generalResponses];
            
            // Случайный выбор ответа
            const randomResponse = allResponses[Math.floor(Math.random() * allResponses.length)];
            
            const responseMessage = {
                sender: friendName,
                receiver: currentUser.username,
                text: randomResponse,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                date: new Date().toISOString().split('T')[0]
            };
            
            users[userIndex].messages.push(responseMessage);
            localStorage.setItem('users', JSON.stringify(users));
            loadMessages();
        }

        // Групповой чат
        function switchGroup(groupName) {
            currentGroup = groupName;
            document.querySelectorAll('.group-option').forEach(option => option.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('groupTitle').textContent = groupTitles[groupName];
            loadGroupMessages();
            updateGroupMembers();
        }

        function loadGroupMessages() {
            const messagesList = document.getElementById('groupMessagesList');
            messagesList.innerHTML = '';

            const userData = getUserData();
            const groupMessages = userData.groupMessages?.[currentGroup] || [];

            if (groupMessages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state">
                        <h3>Пока нет сообщений в этой группе</h3>
                        <p>Напишите первое сообщение!</p>
                    </div>
                `;
                return;
            }

            groupMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                if (message.sender === 'system') {
                    messageDiv.className = 'message system';
                    messageDiv.textContent = message.text;
                } else {
                    messageDiv.className = `message ${message.sender === currentUser.username ? 'own' : 'friend'}`;
                    messageDiv.innerHTML = `
                        <div class="message-sender">${message.sender}</div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${message.time}</div>
                    `;
                }
                messagesList.appendChild(messageDiv);
            });

            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function handleGroupMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendGroupMessage();
            }
        }

        function sendGroupMessage() {
            const messageInput = document.getElementById('groupMessageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                
                if (userIndex !== -1) {
                    if (!users[userIndex].groupMessages) {
                        users[userIndex].groupMessages = {
                            garden: [],
                            plants: [],
                            tips: [],
                            newbies: [],
                            experts: []
                        };
                    }
                    
                    const newMessage = {
                        sender: currentUser.username,
                        text: message,
                        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    users[userIndex].groupMessages[currentGroup].push(newMessage);
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    messageInput.value = '';
                    loadGroupMessages();
                    
                    // Генерируем быстрые ответы от друзей в группе
                    generateImmediateGroupResponses(message);
                }
            }
        }

        function generateImmediateGroupResponses(userMessage) {
            const userData = getUserData();
            const friends = userData.friends || [];
            
            // Выбираем случайных друзей для ответа (от 1 до 3 друзей)
            const respondingFriends = friends
                .filter(() => Math.random() > 0.3) // 70% chance to respond
                .slice(0, Math.floor(Math.random() * 3) + 1);
            
            respondingFriends.forEach((friend, index) => {
                const delay = (index + 1) * 2000; // Ответы через 2, 4, 6 секунд
                
                setTimeout(() => {
                    const responses = groupResponses[currentGroup] || [];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    const userIndex = users.findIndex(u => u.email === currentUser.email);
                    
                    if (userIndex !== -1 && users[userIndex].groupMessages) {
                        const groupMessage = {
                            sender: friend.username,
                            text: response,
                            time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                            date: new Date().toISOString().split('T')[0]
                        };
                        
                        users[userIndex].groupMessages[currentGroup].push(groupMessage);
                        localStorage.setItem('users', JSON.stringify(users));
                        loadGroupMessages();
                    }
                }, delay);
            });
        }

        function updateGroupMembers() {
            const userData = getUserData();
            const friends = userData.friends || [];
            const count = friends.length + 1; // +1 для текущего пользователя
            document.getElementById('groupMembersCount').textContent = count;
            
            // Показываем список участников
            const membersList = document.getElementById('groupMembersList');
            membersList.innerHTML = '';
            
            // Добавляем текущего пользователя
            const currentUserTag = document.createElement('span');
            currentUserTag.className = 'member-tag';
            currentUserTag.textContent = currentUser.username + ' (Вы)';
            membersList.appendChild(currentUserTag);
            
            // Добавляем друзей
            friends.slice(0, 8).forEach(friend => { // Показываем первых 8 друзей
                const friendTag = document.createElement('span');
                friendTag.className = 'member-tag';
                friendTag.textContent = friend.username;
                membersList.appendChild(friendTag);
            });
            
            if (friends.length > 8) {
                const moreTag = document.createElement('span');
                moreTag.className = 'member-tag';
                moreTag.textContent = `+${friends.length - 8} еще`;
                membersList.appendChild(moreTag);
            }
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const resultsGrid = document.getElementById('searchResults');
            resultsGrid.innerHTML = '';

            if (!query) {
                resultsGrid.innerHTML = '<div class="empty-state">Введите имя для поиска</div>';
                return;
            }

            const allUsers = JSON.parse(localStorage.getItem('users')) || [];
            const currentUserData = getUserData();
            const currentFriends = currentUserData.friends || [];

            const searchResults = allUsers.filter(user => 
                user.username.toLowerCase().includes(query) && 
                user.email !== currentUser.email &&
                !currentFriends.some(f => f.username === user.username)
            );

            if (searchResults.length === 0) {
                resultsGrid.innerHTML = '<div class="empty-state">Пользователи не найдены</div>';
                return;
            }

            searchResults.forEach(user => {
                const card = document.createElement('div');
                card.className = 'friend-card';
                card.innerHTML = `
                    <div class="friend-avatar">${user.avatar || user.username.charAt(0)}</div>
                    <div class="friend-name">${user.username}</div>
                    <div class="friend-level">Уровень ${user.level || 1}</div>
                    <div class="friend-stats">
                        <div class="stat">
                            <div class="stat-value">${user.plants || 0}</div>
                            <div class="stat-label">Растения</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${user.friends ? user.friends.length : 0}</div>
                            <div class="stat-label">Друзья</div>
                        </div>
                    </div>
                    <div class="online-status ${user.online ? 'online' : 'offline'}">
                        ${user.online ? '🟢 В сети' : `⚫ ${user.lastSeen || 'Не в сети'}`}
                    </div>
                    <button class="btn btn-primary" onclick="addFriend('${user.username}')">
                        Добавить в друзья
                    </button>
                `;
                resultsGrid.appendChild(card);
            });
        }

        function addFriend(username) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            const friendUser = users.find(u => u.username === username);

            if (userIndex !== -1 && friendUser) {
                if (!users[userIndex].friends) {
                    users[userIndex].friends = [];
                }

                if (!users[userIndex].friends.some(f => f.username === username)) {
                    users[userIndex].friends.push({
                        username: friendUser.username,
                        level: friendUser.level || 1,
                        plants: friendUser.plants || 0,
                        friends: friendUser.friends ? friendUser.friends.length : 0,
                        online: friendUser.online || false,
                        avatar: friendUser.avatar,
                        lastSeen: friendUser.lastSeen,
                        personality: friendUser.personality,
                        responseDelay: friendUser.responseDelay,
                        interests: friendUser.interests
                    });

                    localStorage.setItem('users', JSON.stringify(users));
                    alert(`Пользователь ${username} добавлен в друзья!`);
                    searchUsers();
                    loadFriends();
                    updateGroupMembers();
                }
            }
        }

        function removeFriend(username) {
            if (confirm(`Вы уверены, что хотите удалить ${username} из друзей?`)) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);

                if (userIndex !== -1 && users[userIndex].friends) {
                    users[userIndex].friends = users[userIndex].friends.filter(f => f.username !== username);
                    localStorage.setItem('users', JSON.stringify(users));
                    loadFriends();
                    updateGroupMembers();
                    
                    if (selectedFriend === username) {
                        selectedFriend = null;
                        if (currentTab === 'messages') {
                            loadMessages();
                        }
                    }
                }
            }
        }

        function getUserData() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            return users.find(u => u.email === currentUser.email) || {};
        }
    </script>
    <script>
// Общий код для применения темы на всех страницах
function applyThemeSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
    
    if (settings.theme) {
        document.body.setAttribute('data-theme', settings.theme);
        
        // Применяем dark mode для не-темных тем
        if (settings.darkMode && settings.theme !== 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
    
    // Применяем настройки шрифта если есть
    if (settings.fontSize) {
        document.body.style.fontSize = settings.fontSize + 'px';
    }
    if (settings.fontFamily) {
        document.body.style.fontFamily = settings.fontFamily + ', sans-serif';
    }
}

// Применяем настройки при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    applyThemeSettings();
});
</script>
</body>
</html>